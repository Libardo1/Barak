

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>barak.spec &mdash; Barak 0.1dev documentation</title>
    
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/theme_extras.js"></script>
    <link rel="top" title="Barak 0.1dev documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../index.html">
          <span>Barak 0.1dev documentation</span></a></h1>
        <h2 class="heading"><span>barak.spec</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for barak.spec</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot; Contains an object to describe a spectrum, and various</span>
<span class="sd">spectrum-related functions.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pdb</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">pl</span>

<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">nan2num</span><span class="p">,</span> <span class="n">between</span><span class="p">,</span> <span class="n">get_data_path</span>
<span class="kn">from</span> <span class="nn">convolve</span> <span class="kn">import</span> <span class="n">convolve_psf</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">readtxt</span><span class="p">,</span> <span class="n">readtabfits</span>
<span class="kn">from</span> <span class="nn">plot</span> <span class="kn">import</span> <span class="n">axvlines</span><span class="p">,</span> <span class="n">axvfill</span><span class="p">,</span> <span class="n">puttext</span>
<span class="kn">from</span> <span class="nn">constants</span> <span class="kn">import</span> <span class="n">c_kms</span>

<span class="n">DATAPATH</span> <span class="o">=</span> <span class="n">get_data_path</span><span class="p">()</span>

<span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
<div class="viewcode-block" id="getwave"><a class="viewcode-back" href="../../generated/barak.spec.getwave.html#barak.spec.getwave">[docs]</a><span class="k">def</span> <span class="nf">getwave</span><span class="p">(</span><span class="n">hd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Given a fits header, get the wavelength solution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dv</span><span class="o">=</span><span class="bp">None</span>
    <span class="k">if</span> <span class="n">hd</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;CDELT1&#39;</span><span class="p">):</span>
        <span class="n">dw</span> <span class="o">=</span> <span class="n">hd</span><span class="p">[</span><span class="s">&#39;CDELT1&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dw</span> <span class="o">=</span> <span class="n">hd</span><span class="p">[</span><span class="s">&#39;CD1_1&#39;</span><span class="p">]</span>
    <span class="n">CRVAL</span> <span class="o">=</span> <span class="n">hd</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span>
    <span class="n">CRPIX</span> <span class="o">=</span> <span class="n">hd</span><span class="p">[</span><span class="s">&#39;CRPIX1&#39;</span><span class="p">]</span>
    <span class="c"># wavelength of pixel 1</span>
    <span class="n">wstart</span> <span class="o">=</span> <span class="n">CRVAL</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">CRPIX</span><span class="p">)</span> <span class="o">*</span> <span class="n">dw</span>
    <span class="c"># check if it&#39;s log-linear scale (heuristic)</span>
    <span class="k">if</span> <span class="n">CRVAL</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">wstart</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">wstart</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">c_kms</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">10.</span> <span class="o">**</span> <span class="o">-</span><span class="n">dw</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;constant dv = </span><span class="si">%.3f</span><span class="s"> km/s (assume CRVAL1 in log(Angstroms))&#39;</span> <span class="o">%</span> <span class="n">dv</span>

    <span class="n">npts</span> <span class="o">=</span> <span class="n">hd</span><span class="p">[</span><span class="s">&#39;NAXIS1&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">make_wa_scale</span><span class="p">(</span><span class="n">wstart</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">constantdv</span><span class="o">=</span><span class="n">dv</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="find_wa_edges"><a class="viewcode-back" href="../../generated/barak.spec.find_wa_edges.html#barak.spec.find_wa_edges">[docs]</a><span class="k">def</span> <span class="nf">find_wa_edges</span><span class="p">(</span><span class="n">wa</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Given wavelength bin centres, find the edges of wavelengh</span>
<span class="sd">    bins.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; print find_wa_edges([1, 2.1, 3.3, 4.6])</span>
<span class="sd">    [ 0.45  1.55  2.7   3.95  5.25]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wa</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">wa</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">wa</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">wa</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">wa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">edges</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">wa</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="make_wa_scale"><a class="viewcode-back" href="../../generated/barak.spec.make_wa_scale.html#barak.spec.make_wa_scale">[docs]</a><span class="k">def</span> <span class="nf">make_wa_scale</span><span class="p">(</span><span class="n">wstart</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">constantdv</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Generates a wavelength scale from the wstart, dw, and npts</span>
<span class="sd">    values.</span>

<span class="sd">    &gt;&gt;&gt; print make_wa_scale(40, 1, 5)</span>
<span class="sd">    [40., 41., 42., 43., 44.]</span>
<span class="sd">    &gt;&gt;&gt; print make_wa_scale(3.5, 1e-3, 5, constantdv=True)</span>
<span class="sd">    [3162.278,  3169.568,  3176.874,  3184.198, 3191.537]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">constantdv</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="k">print</span> <span class="s">&#39;make_wa_scale(): Using log-linear scale&#39;</span>
        <span class="n">wa</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">wstart</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">dw</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="k">print</span> <span class="s">&#39;make_wa_scale(): Using linear scale&#39;</span>
        <span class="n">wa</span> <span class="o">=</span> <span class="n">wstart</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">dw</span>
    <span class="k">return</span> <span class="n">wa</span>
</div>
<div class="viewcode-block" id="Spectrum"><a class="viewcode-back" href="../../generated/barak.spec.Spectrum.html#barak.spec.Spectrum">[docs]</a><span class="k">class</span> <span class="nc">Spectrum</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A class to hold information about a spectrum.</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    wa : array of floats, shape(N,)</span>
<span class="sd">      Wavelength values (overrides all wavelength keywords)</span>
<span class="sd">    fl : array of floats, shape(N,)</span>
<span class="sd">      Flux.</span>
<span class="sd">    er : array of floats, shape(N,)</span>
<span class="sd">      Error.</span>
<span class="sd">    co : array of floats, shape(N,)</span>
<span class="sd">      Continuum.</span>
<span class="sd">    dw : float</span>
<span class="sd">      Wavelength difference between adjacent pixel centres.</span>
<span class="sd">    dv : float</span>
<span class="sd">      Velocity difference (km/s)</span>
<span class="sd">    fwhm : float</span>
<span class="sd">      Instrumental FWHM in km/s</span>
<span class="sd">    filename : str</span>
<span class="sd">      Filename of spectrum</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If enough information is given, the wavelength scale will be</span>
<span class="sd">    generated.  Note that there is no error check if you give</span>
<span class="sd">    conflicting wavelength scale information in the keywords!  In this</span>
<span class="sd">    case certain combinations of keywords take precendence.  See the</span>
<span class="sd">    code comments for details.</span>

<span class="sd">    Notes for FITS header::</span>
<span class="sd">    </span>
<span class="sd">     wstart = CRVAL - (CRPIX - 1.0) * CDELT,  dw = CDELT</span>

<span class="sd">    Conversion between velocity width and log-linear pixel width::</span>
<span class="sd">    </span>
<span class="sd">     dv / c_kms = 1 - 10**(-dw)</span>


<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; sp = Spectrum(wstart=4000, dw=1, npts=500)</span>
<span class="sd">    &gt;&gt;&gt; sp = Spectrum(wstart=4000, dv=60, npts=500)</span>
<span class="sd">    &gt;&gt;&gt; sp = Spectrum(wstart=4000, wend=4400, npts=500)</span>
<span class="sd">    &gt;&gt;&gt; wa = np.linspace(4000, 5000, 500)</span>
<span class="sd">    &gt;&gt;&gt; fl = np.ones(len(wa))</span>
<span class="sd">    &gt;&gt;&gt; sp = Spectrum(wa=wa, fl=fl)</span>
<span class="sd">    &gt;&gt;&gt; sp = Spectrum(CRVAL=4000, CRPIX=1, CDELT=1, fl=np.ones(500))</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Spectrum.__init__"><a class="viewcode-back" href="../../generated/barak.spec.Spectrum.html#barak.spec.Spectrum.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">dw</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dv</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">wstart</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">wend</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">CRVAL</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">CRPIX</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">CDELT</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">wa</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fl</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">er</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">co</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">fwhm</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create the wavelength scale and initialise attributes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
            <span class="n">fl</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">fl</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fl</span> <span class="o">=</span> <span class="n">fl</span>
            <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">er</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">er</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">er</span><span class="p">)</span>
            <span class="c"># replace bad values with NaN</span>
            <span class="n">er</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">er</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">er</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">er</span> <span class="o">=</span> <span class="n">er</span>
            <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">er</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">co</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
            <span class="n">co</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">co</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">co</span> <span class="o">=</span> <span class="n">co</span>
            <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>

        <span class="c"># Check whether we need to make a wavelength scale.</span>
        <span class="n">makescale</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">dv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">dv</span> <span class="o">/</span> <span class="n">c_kms</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">CRVAL</span><span class="p">,</span> <span class="n">CRPIX</span><span class="p">,</span> <span class="n">CDELT</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">wstart</span> <span class="o">=</span> <span class="n">CRVAL</span> <span class="o">-</span> <span class="p">(</span><span class="n">CRPIX</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">CDELT</span>
            <span class="n">dw</span> <span class="o">=</span> <span class="n">CDELT</span>
            <span class="c"># check if it&#39;s log-linear scale (heuristic)</span>
            <span class="k">if</span> <span class="n">CRVAL</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">wstart</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">wstart</span>
                <span class="n">dv</span> <span class="o">=</span> <span class="n">c_kms</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">10.</span> <span class="o">**</span> <span class="o">-</span><span class="n">dw</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">wa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wa</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
            <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wa</span><span class="p">)</span>
            <span class="n">makescale</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="bp">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">wstart</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">npts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">wstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">wstart</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">wstart</span><span class="p">,</span> <span class="n">wend</span><span class="p">,</span> <span class="n">dw</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">wstart</span><span class="p">,</span> <span class="n">wend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">([</span><span class="n">wstart</span><span class="p">,</span><span class="n">wend</span><span class="p">])</span>
            <span class="c"># make sure the scale is the same or bigger than the</span>
            <span class="c"># requested wavelength range</span>
            <span class="n">npts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">wend</span> <span class="o">-</span> <span class="n">wstart</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">dw</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="bp">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">wstart</span><span class="p">,</span> <span class="n">wend</span><span class="p">,</span> <span class="n">npts</span><span class="p">):</span>
            <span class="c"># Make a linear wavelength scale</span>
            <span class="n">dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">wend</span> <span class="o">-</span> <span class="n">wstart</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">npts</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">wend</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">npts</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Please specify wstart instead of wend&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Not enough info to make a wavelength scale!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">makescale</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;making wav scale,&#39;</span><span class="p">,</span> <span class="n">wstart</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span>
            <span class="n">wa</span> <span class="o">=</span> <span class="n">make_wa_scale</span><span class="p">(</span><span class="n">wstart</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">constantdv</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">dv</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># check whether wavelength scale is linear or log-linear</span>
            <span class="c"># (constant velocity)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">wa</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">wa</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">dw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">wa</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">wa</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">dw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
                    <span class="n">dv</span> <span class="o">=</span> <span class="n">c_kms</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">dw</span><span class="p">)</span>

        <span class="c"># assign remaining attributes</span>
        <span class="k">if</span> <span class="n">fl</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">er</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">er</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c"># error (one sig)</span>
        <span class="k">if</span> <span class="n">co</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="n">fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw</span> <span class="o">=</span> <span class="n">dw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dv</span> <span class="o">=</span> <span class="n">dv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wa</span> <span class="o">=</span> <span class="n">wa</span>
</div>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Spectrum(wa, fl, er, co, dw, dv, fwhm, filename)&#39;</span>

<div class="viewcode-block" id="Spectrum.multiply"><a class="viewcode-back" href="../../generated/barak.spec.Spectrum.multiply.html#barak.spec.Spectrum.multiply">[docs]</a>    <span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Multipy the flux, error and continuum by `val`.</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; sp = Spectrum(wstart=4000, dw=1, npts=500, fl=np.ones(500))</span>
<span class="sd">        &gt;&gt;&gt; sp.multiply(2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fl</span> <span class="o">*=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">er</span> <span class="o">*=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">co</span> <span class="o">*=</span> <span class="n">val</span>
</div>
<div class="viewcode-block" id="Spectrum.plot"><a class="viewcode-back" href="../../generated/barak.spec.Spectrum.plot.html#barak.spec.Spectrum.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">yperc</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
             <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;steps-mid&#39;</span><span class="p">,</span>
             <span class="n">flcolor</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">cocolor</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plots a spectrum.</span>

<span class="sd">        Returns the matplotlib artists that represent the flux, error</span>
<span class="sd">        and continuum curves.        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">co</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa</span>
        <span class="k">return</span> <span class="n">plot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">yperc</span><span class="o">=</span><span class="n">yperc</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span>
                    <span class="n">flcolor</span><span class="o">=</span><span class="n">flcolor</span><span class="p">,</span> <span class="n">cocolor</span><span class="o">=</span><span class="n">cocolor</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Spectrum.stats"><a class="viewcode-back" href="../../generated/barak.spec.Spectrum.stats.html#barak.spec.Spectrum.stats">[docs]</a>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wa1</span><span class="p">,</span> <span class="n">wa2</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates statistics (mean, standard deviation (i.e. RMS), mean</span>
<span class="sd">        error, etc) of the flux between two wavelength points.</span>

<span class="sd">        Returns::</span>
<span class="sd">        </span>
<span class="sd">         mean flux, RMS of flux, mean error, SNR:</span>
<span class="sd">            SNR = (mean flux / RMS)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wa</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">([</span><span class="n">wa1</span><span class="p">,</span> <span class="n">wa2</span><span class="p">])</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
        <span class="n">er</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
        <span class="n">good</span> <span class="o">=</span> <span class="p">(</span><span class="n">er</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;No good data in this range!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">fl</span><span class="p">[</span><span class="n">good</span><span class="p">]</span>
        <span class="n">er</span> <span class="o">=</span> <span class="n">er</span><span class="p">[</span><span class="n">good</span><span class="p">]</span>
        <span class="n">mfl</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">mer</span> <span class="o">=</span> <span class="n">er</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="n">mfl</span> <span class="o">/</span> <span class="n">std</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;mean </span><span class="si">%g</span><span class="s">, std </span><span class="si">%g</span><span class="s">, er </span><span class="si">%g</span><span class="s">, snr </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mfl</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">mer</span><span class="p">,</span> <span class="n">snr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mfl</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">mer</span><span class="p">,</span> <span class="n">snr</span>
</div>
<div class="viewcode-block" id="Spectrum.rebin"><a class="viewcode-back" href="../../generated/barak.spec.Spectrum.rebin.html#barak.spec.Spectrum.rebin">[docs]</a>    <span class="k">def</span> <span class="nf">rebin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Class method version of spec.rebin() &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">rebin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">er</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Spectrum.rebin_simple"><a class="viewcode-back" href="../../generated/barak.spec.Spectrum.rebin_simple.html#barak.spec.Spectrum.rebin_simple">[docs]</a>    <span class="k">def</span> <span class="nf">rebin_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Class method version of spec.rebin_simple().&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">rebin_simple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">er</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">co</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="Spectrum.write"><a class="viewcode-back" href="../../generated/barak.spec.Spectrum.write.html#barak.spec.Spectrum.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Writes out a spectrum, as ascii - wavelength, flux, error,</span>
<span class="sd">        continuum.</span>

<span class="sd">        `overwrite` can be True or False.</span>

<span class="sd">        `header` is a string to be written to the file before the</span>
<span class="sd">        spectrum. A special case is `header=&#39;RESVEL&#39;`, which means the</span>
<span class="sd">        instrumental fwhm in km/s will be written on the first line</span>
<span class="sd">        (VPFIT style).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lexists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;File </span><span class="si">%s</span><span class="s"> exists - overwrite? (y) or n: &#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;n&#39;</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;returning without writing anything...&#39;</span>
                    <span class="k">return</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="s">&#39;RESVEL&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Instrumental fwhm is not set!&#39;</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;RESVEL </span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fl</span><span class="p">)</span>
        <span class="n">er</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">er</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">co</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">w</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wa</span><span class="p">,</span> <span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="p">):</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">% .12g</span><span class="s"> </span><span class="si">% #12.8g</span><span class="s"> </span><span class="si">% #12.8g</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">co</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">w</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wa</span><span class="p">,</span> <span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="p">,</span> <span class="n">co</span><span class="p">):</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">% .12g</span><span class="s"> </span><span class="si">% #12.8g</span><span class="s"> </span><span class="si">% #12.8g</span><span class="s"> </span><span class="si">% #12.8g</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</div></div>
<div class="viewcode-block" id="read"><a class="viewcode-back" href="../../generated/barak.spec.read.html#barak.spec.read">[docs]</a><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&#39;#&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in QSO spectrum given a filename.  Returns a Spectrum class</span>
<span class="sd">    object:</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">    comment : str (&#39;#&#39;)</span>
<span class="sd">      String that marks beginning of comment line, only used when</span>
<span class="sd">      reading in ascii files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.gz&#39;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">gzip</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">9</span> <span class="ow">or</span> <span class="n">test</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;=&#39;</span><span class="p">:</span> 
    <span class="c"># Then probably not a fits file</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;RESVEL&#39;</span><span class="p">:</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>         <span class="c"># uves_popler .dat file            </span>
            <span class="n">wa</span><span class="p">,</span><span class="n">fl</span><span class="p">,</span><span class="n">er</span><span class="p">,</span><span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                     <span class="n">comments</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="n">skip</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wa</span><span class="p">,</span><span class="n">fl</span><span class="p">,</span><span class="n">er</span><span class="p">,</span><span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                         <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
                                         <span class="n">skiprows</span><span class="o">=</span><span class="n">skip</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wa</span><span class="p">,</span><span class="n">fl</span><span class="p">,</span><span class="n">er</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                                          <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
                                          <span class="n">skiprows</span><span class="o">=</span><span class="n">skip</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">wa</span><span class="p">,</span><span class="n">fl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                                       <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
                                       <span class="n">skiprows</span><span class="o">=</span><span class="n">skip</span><span class="p">)</span>
                    <span class="n">er</span> <span class="o">=</span> <span class="n">find_err</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">find_cont</span><span class="p">(</span><span class="n">fl</span><span class="p">))</span>
                <span class="n">co</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># heuristic to check for Jill Bechtold&#39;s FOS spectra</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.XY&#39;</span><span class="p">):</span>
                <span class="n">wa</span><span class="p">,</span><span class="n">fl</span><span class="p">,</span><span class="n">er</span><span class="p">,</span><span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
                    <span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
                    <span class="n">skiprows</span><span class="o">=</span><span class="n">skip</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fl</span> <span class="o">*=</span> <span class="n">co</span>
                <span class="n">er</span> <span class="o">*=</span> <span class="n">co</span>

        <span class="k">if</span> <span class="n">wa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">wa</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">wa</span> <span class="o">=</span> <span class="n">wa</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>  <span class="n">fl</span> <span class="o">=</span> <span class="n">fl</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
            <span class="k">if</span> <span class="n">er</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="n">er</span> <span class="o">=</span> <span class="n">er</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">co</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="n">co</span> <span class="o">=</span> <span class="n">co</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">wa</span><span class="o">=</span><span class="n">wa</span><span class="p">,</span> <span class="n">fl</span><span class="o">=</span><span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="o">=</span><span class="n">er</span><span class="p">,</span> <span class="n">co</span><span class="o">=</span><span class="n">co</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sp</span>

    <span class="c"># Otherwise assume fits file</span>
    <span class="kn">import</span> <span class="nn">pyfits</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">hd</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="c"># try record array</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">good</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
        <span class="k">if</span> <span class="s">&#39;wa&#39;</span> <span class="ow">in</span>  <span class="n">names</span> <span class="ow">and</span> <span class="s">&#39;fl&#39;</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">wa</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">wa</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">fl</span>
            <span class="n">good</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="s">&#39;wavelength&#39;</span> <span class="ow">in</span> <span class="n">names</span> <span class="ow">and</span> <span class="s">&#39;flux&#39;</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">wa</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">wavelength</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">flux</span>
            <span class="n">good</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">good</span><span class="p">:</span>
            <span class="n">er</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">er</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">er</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">co</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">co</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">wa</span><span class="o">=</span><span class="n">wa</span><span class="p">,</span> <span class="n">fl</span><span class="o">=</span><span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="o">=</span><span class="n">er</span><span class="p">,</span> <span class="n">co</span><span class="o">=</span><span class="n">co</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

    <span class="c">##################################################################</span>
    <span class="c">#  First generate the wavelength scale.  Look for CTYPE, CRVAL,</span>
    <span class="c">#  CDELT header cards.  Then read in flux values, and look for</span>
    <span class="c">#  cont and error axes/files.</span>
    <span class="c">##################################################################</span>

    <span class="c">#naxis1 = hd[&#39;NAXIS1&#39;]     # 1st axis length (no. data points)</span>
    <span class="c"># pixel stepsize</span>
    <span class="k">if</span> <span class="n">hd</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;CDELT1&#39;</span><span class="p">):</span>
        <span class="n">cdelt</span> <span class="o">=</span> <span class="n">hd</span><span class="p">[</span><span class="s">&#39;CDELT1&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">hd</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;CD1_1&#39;</span><span class="p">):</span>
        <span class="n">cdelt</span> <span class="o">=</span> <span class="n">hd</span><span class="p">[</span><span class="s">&#39;CD1_1&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Read Songaila&#39;s spectra</span>
        <span class="n">wa</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">er</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">er</span><span class="p">[</span><span class="n">er</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">npts</span><span class="p">):</span>
                <span class="n">er</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">npts</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">)</span> 
            <span class="n">er</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">50</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">50</span><span class="p">])</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">wa</span><span class="o">=</span><span class="n">wa</span><span class="p">,</span> <span class="n">fl</span><span class="o">=</span><span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="o">=</span><span class="n">er</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

    <span class="c">##########################################################</span>
    <span class="c"># Check if SDSS spectrum</span>
    <span class="c">##########################################################</span>
    <span class="k">if</span> <span class="n">hd</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;TELESCOP&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">hd</span><span class="p">[</span><span class="s">&#39;TELESCOP&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;SDSS 2.5-M&#39;</span><span class="p">:</span>  <span class="c"># then Sloan spectrum</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">er</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">fl</span><span class="o">=</span><span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="o">=</span><span class="n">er</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">CDELT</span><span class="o">=</span><span class="n">cdelt</span><span class="p">,</span>
                            <span class="n">CRVAL</span><span class="o">=</span><span class="n">hd</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">],</span> <span class="n">CRPIX</span><span class="o">=</span><span class="n">hd</span><span class="p">[</span><span class="s">&#39;CRPIX1&#39;</span><span class="p">])</span>

    <span class="c">##########################################################</span>
    <span class="c"># Check if HIRES spectrum</span>
    <span class="c">##########################################################</span>
    <span class="k">if</span> <span class="n">hd</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;INSTRUME&#39;</span><span class="p">):</span>   <span class="c">#  Check if Keck spectrum</span>
        <span class="k">if</span> <span class="n">hd</span><span class="p">[</span><span class="s">&#39;INSTRUME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;HIRES&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>  <span class="k">print</span> <span class="s">&#39;Looks like Makee output format&#39;</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>       <span class="c"># Flux</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">errname</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">filename</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.fits&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="s">&#39;e.fits&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">er</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">errname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">er</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fl</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">fl</span><span class="o">=</span><span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="o">=</span><span class="n">er</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">CDELT</span><span class="o">=</span><span class="n">cdelt</span><span class="p">,</span>
                            <span class="n">CRVAL</span><span class="o">=</span><span class="n">hd</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">],</span> <span class="n">CRPIX</span><span class="o">=</span><span class="n">hd</span><span class="p">[</span><span class="s">&#39;CRPIX1&#39;</span><span class="p">])</span>

    <span class="c">##########################################################</span>
    <span class="c"># Check if UVES_popler output</span>
    <span class="c">##########################################################</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">hd</span><span class="o">.</span><span class="n">get_history</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;UVES POst Pipeline Echelle Reduction&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">co</span> <span class="c">#  Flux</span>
            <span class="n">er</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">co</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">fl</span><span class="o">=</span><span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="o">=</span><span class="n">er</span><span class="p">,</span> <span class="n">co</span><span class="o">=</span><span class="n">co</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">CDELT</span><span class="o">=</span><span class="n">cdelt</span><span class="p">,</span>
                            <span class="n">CRVAL</span><span class="o">=</span><span class="n">hd</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">],</span> <span class="n">CRPIX</span><span class="o">=</span><span class="n">hd</span><span class="p">[</span><span class="s">&#39;CRPIX1&#39;</span><span class="p">])</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">fl</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">er</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">hd</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;CRPIX1&#39;</span><span class="p">):</span>
        <span class="n">crpix</span> <span class="o">=</span> <span class="n">hd</span><span class="p">[</span><span class="s">&#39;CRPIX1&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">crpix</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">fl</span><span class="o">=</span><span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="o">=</span><span class="n">er</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">CDELT</span><span class="o">=</span><span class="n">cdelt</span><span class="p">,</span>
                    <span class="n">CRVAL</span><span class="o">=</span><span class="n">hd</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">],</span> <span class="n">CRPIX</span><span class="o">=</span><span class="n">crpix</span><span class="p">)</span>
    <span class="c">#raise Exception(&#39;Unknown file format&#39;)</span>
</div>
<div class="viewcode-block" id="rebin_simple"><a class="viewcode-back" href="../../generated/barak.spec.rebin_simple.html#barak.spec.rebin_simple">[docs]</a><span class="k">def</span> <span class="nf">rebin_simple</span><span class="p">(</span><span class="n">wa</span><span class="p">,</span> <span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Bins up the spectrum by averaging the values of every n</span>
<span class="sd">    pixels. Not very accurate, but much faster than rebin().</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">remain</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wa</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">None</span>
    <span class="n">wa</span> <span class="o">=</span> <span class="n">wa</span><span class="p">[:</span><span class="n">remain</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">fl</span> <span class="o">=</span> <span class="n">fl</span><span class="p">[:</span><span class="n">remain</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">er</span> <span class="o">=</span> <span class="n">er</span><span class="p">[:</span><span class="n">remain</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">co</span><span class="p">[:</span><span class="n">remain</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">wa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">wa</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> 
    <span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> 
    <span class="n">er</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">er</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> 
    <span class="n">fl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> 

    <span class="k">return</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">wa</span><span class="o">=</span><span class="n">wa</span><span class="p">,</span> <span class="n">fl</span><span class="o">=</span><span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="o">=</span><span class="n">er</span><span class="p">,</span> <span class="n">co</span><span class="o">=</span><span class="n">co</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="rebin"><a class="viewcode-back" href="../../generated/barak.spec.rebin.html#barak.spec.rebin">[docs]</a><span class="k">def</span> <span class="nf">rebin</span><span class="p">(</span><span class="n">wav</span><span class="p">,</span> <span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Rebins spectrum to a new wavelength scale generated using the</span>
<span class="sd">    keyword parameters.</span>

<span class="sd">    Returns the rebinned spectrum.</span>

<span class="sd">    Accepts the same keywords as Spectrum.__init__() (see that</span>
<span class="sd">    docstring for a description of those keywords)</span>

<span class="sd">    Will probably get the flux and errors for the first and last pixel</span>
<span class="sd">    of the rebinned spectrum wrong.</span>

<span class="sd">    General pointers about rebinning if you care about errors in the</span>
<span class="sd">    rebinned values:</span>

<span class="sd">    1. Don&#39;t rebin to a smaller bin size.</span>
<span class="sd">    2. Be aware when you rebin you introduce correlations between</span>
<span class="sd">       neighbouring points and between their errors.</span>
<span class="sd">    3. Rebin as few times as possible.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Note: 0 suffix indicates the old spectrum, 1 the rebinned spectrum.</span>
    <span class="n">colors</span><span class="o">=</span> <span class="s">&#39;brgy&#39;</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    
    <span class="c"># Create rebinned spectrum wavelength scale</span>
    <span class="n">sp1</span> <span class="o">=</span> <span class="n">Spectrum</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c"># find pixel edges, used when rebinning</span>
    <span class="n">edges0</span> <span class="o">=</span> <span class="n">find_wa_edges</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span>
    <span class="n">edges1</span> <span class="o">=</span> <span class="n">find_wa_edges</span><span class="p">(</span><span class="n">sp1</span><span class="o">.</span><span class="n">wa</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">x0</span><span class="p">,</span><span class="n">x1</span> <span class="o">=</span> <span class="n">edges1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">yh</span><span class="p">,</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;dotted&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">widths0</span> <span class="o">=</span> <span class="n">edges0</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">edges0</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">npts0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span>
    <span class="n">npts1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp1</span><span class="o">.</span><span class="n">wa</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">de2</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">npix</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c"># number of old pixels contributing to rebinned pixel,</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>                <span class="c"># index of rebinned array</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>                <span class="c"># index of old array</span>

    <span class="c"># sanity check</span>
    <span class="k">if</span> <span class="n">edges0</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">edges1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">edges1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">edges0</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Wavelength scales do not overlap!&#39;</span><span class="p">)</span>
    
    <span class="c"># find the first contributing old pixel to the rebinned spectrum</span>
    <span class="k">if</span> <span class="n">edges0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">edges1</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c"># Old wa scale extends lower than the rebinned scale. Find the</span>
        <span class="c"># first old pixel that overlaps with rebinned scale.</span>
        <span class="k">while</span> <span class="n">edges0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">edges1</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">edges0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edges1</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c"># New rebinned wa scale extends lower than the old scale. Find</span>
        <span class="c"># the first rebinned pixel that overlaps with the old spectrum</span>
        <span class="k">while</span> <span class="n">edges0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edges1</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">sp1</span><span class="o">.</span><span class="n">fl</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">sp1</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">lo0</span> <span class="o">=</span> <span class="n">edges0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>      <span class="c"># low edge of contr. (sub-)pixel in old scale</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">hi0</span> <span class="o">=</span> <span class="n">edges0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="c"># upper edge of contr. (sub-)pixel in old scale</span>
        <span class="n">hi1</span> <span class="o">=</span> <span class="n">edges1</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="c"># upper edge of jth pixel in rebinned scale</span>

        <span class="k">if</span> <span class="n">hi0</span> <span class="o">&lt;</span> <span class="n">hi1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">er</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dpix</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi0</span> <span class="o">-</span> <span class="n">lo0</span><span class="p">)</span> <span class="o">/</span> <span class="n">widths0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">df</span> <span class="o">+=</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dpix</span>
                <span class="c"># We don&#39;t square dpix below, since this causes an</span>
                <span class="c"># artificial variation in the rebinned errors depending on</span>
                <span class="c"># how the old wav bins are divided up into the rebinned</span>
                <span class="c"># wav bins.</span>
                <span class="c">#</span>
                <span class="c"># i.e. 0.25**2 + 0.75**2 != 0.5**2 + 0.5**2 != 1**2</span>
                <span class="n">de2</span> <span class="o">+=</span> <span class="n">er</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dpix</span>
                <span class="n">npix</span> <span class="o">+=</span> <span class="n">dpix</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">yh</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="n">df</span><span class="o">/</span><span class="n">npix</span><span class="p">)</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">lo0</span><span class="p">,</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">hi0</span><span class="o">-</span><span class="n">lo0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">lo0</span><span class="p">,</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#39;lo0&#39;</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">hi0</span><span class="p">,</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#39;hi0&#39;</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">hi1</span><span class="p">,</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#39;hi1&#39;</span><span class="p">)</span>
                <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;enter...&#39;</span><span class="p">)</span>
            <span class="n">lo0</span> <span class="o">=</span> <span class="n">hi0</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">npts0</span><span class="p">:</span>  <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># We have all old pixel flux values that contribute to the</span>
            <span class="c"># new pixel; append the new flux value and move to the</span>
            <span class="c"># next new pixel.</span>
            <span class="k">if</span> <span class="n">er</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dpix</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi1</span> <span class="o">-</span> <span class="n">lo0</span><span class="p">)</span> <span class="o">/</span> <span class="n">widths0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">df</span> <span class="o">+=</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dpix</span>
                <span class="n">de2</span> <span class="o">+=</span> <span class="n">er</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dpix</span>
                <span class="n">npix</span> <span class="o">+=</span> <span class="n">dpix</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">yh</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="n">df</span><span class="o">/</span><span class="n">npix</span><span class="p">)</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">lo0</span><span class="p">,</span>  <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">hi1</span><span class="o">-</span><span class="n">lo0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">lo0</span><span class="p">,</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#39;lo0&#39;</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">hi0</span><span class="p">,</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#39;hi0&#39;</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">hi1</span><span class="p">,</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#39;hi1&#39;</span><span class="p">)</span>
                <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;df, de2, npix: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">   enter...&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">de2</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">npix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># find total flux and error, then divide by number of</span>
                <span class="c"># pixels (i.e. conserve flux density).</span>
                <span class="n">sp1</span><span class="o">.</span><span class="n">fl</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span> <span class="o">/</span> <span class="n">npix</span>
                <span class="n">sp1</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">de2</span><span class="p">)</span> <span class="o">/</span> <span class="n">npix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sp1</span><span class="o">.</span><span class="n">fl</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">sp1</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">df</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">de2</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">npix</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">lo0</span> <span class="o">=</span> <span class="n">hi1</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">npts1</span><span class="p">:</span>  <span class="k">break</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">x0</span><span class="p">,</span><span class="n">x1</span> <span class="o">=</span> <span class="n">edges1</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">yh</span><span class="p">,</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">,</span>
                       <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;enter...&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sp1</span>
</div>
<div class="viewcode-block" id="combine"><a class="viewcode-back" href="../../generated/barak.spec.combine.html#barak.spec.combine">[docs]</a><span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">cliphi</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cliplo</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Combine spectra pixel by pixel, weighting by the inverse variance</span>
<span class="sd">    of each pixel.  Clip high sigma values by sigma times clip values</span>
<span class="sd">    Returns the combined spectrum.</span>

<span class="sd">    If the wavelength scales of the input spectra differ, combine()</span>
<span class="sd">    will rebin the spectra to a common linear (not log-linear)</span>
<span class="sd">    wavelength scale, with pixel width equal to the largest pixel</span>
<span class="sd">    width in the input spectra. If this is not what you want, rebin</span>
<span class="sd">    the spectra by hand with rebin() before using combine().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="n">cliphi</span><span class="p">,</span> <span class="n">cliplo</span><span class="p">,</span> <span class="n">s_rebinned</span><span class="p">):</span>
        <span class="c"># clip the rebinned input spectra</span>

        <span class="c"># find pixels where we can clip: where we have at least three</span>
        <span class="c"># good contributing values.</span>
        <span class="n">goodpix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s_rebinned</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">wa</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s_rebinned</span><span class="p">:</span>
            <span class="n">goodpix</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">er</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">canclip</span> <span class="o">=</span> <span class="n">goodpix</span> <span class="o">&gt;</span> <span class="mi">2</span>
        <span class="c"># find median values</span>
        <span class="n">medfl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">fl</span><span class="p">[</span><span class="n">canclip</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s_rebinned</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">nclipped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_rebinned</span><span class="p">):</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">fl</span><span class="p">[</span><span class="n">canclip</span><span class="p">]</span>
            <span class="n">er</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">canclip</span><span class="p">]</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">fl</span> <span class="o">-</span> <span class="n">medfl</span><span class="p">)</span> <span class="o">/</span> <span class="n">er</span>
            <span class="k">if</span> <span class="n">cliphi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">badpix</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">cliphi</span>
                <span class="n">s_rebinned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">canclip</span><span class="p">][</span><span class="n">badpix</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">nclipped</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">badpix</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cliplo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">badpix</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">cliplo</span>
                <span class="n">s_rebinned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">canclip</span><span class="p">][</span><span class="n">badpix</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">nclipped</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">badpix</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span> <span class="n">nclipped</span><span class="p">,</span> <span class="s">&#39;pixels clipped across all input spectra&#39;</span>
        <span class="k">return</span> <span class="n">nclipped</span>

    <span class="n">nspectra</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> spectra to combine&#39;</span> <span class="o">%</span> <span class="n">nspectra</span>
    <span class="k">if</span> <span class="n">nspectra</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Need at least 2 spectra to combine.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cliphi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">nspectra</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="n">cliphi</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">cliplo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">nspectra</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="n">cliplo</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># Check if wavescales are the same:</span>
    <span class="n">spec0</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">wa</span> <span class="o">=</span> <span class="n">spec0</span><span class="o">.</span><span class="n">wa</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wa</span><span class="p">)</span>
    <span class="n">needrebin</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spectra</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">wa</span><span class="p">)</span> <span class="o">!=</span> <span class="n">npts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;Rebin required&#39;</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">wa</span> <span class="o">-</span> <span class="n">wa</span><span class="p">)</span> <span class="o">/</span> <span class="n">wa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">wa</span> <span class="o">-</span> <span class="n">wa</span><span class="p">)</span> <span class="o">/</span> <span class="n">wa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="s">&#39;Rebin required&#39;</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">needrebin</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="k">print</span> <span class="s">&#39;No rebin required&#39;</span>

    <span class="c"># interpolate over 1 sigma error arrays</span>
    
    <span class="k">if</span> <span class="n">needrebin</span><span class="p">:</span>
        <span class="c"># Make wavelength scale for combined spectrum.  Only linear for now.</span>
        <span class="n">wstart</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">wa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spectra</span><span class="p">)</span>
        <span class="n">wend</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">wa</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spectra</span><span class="p">)</span>
        <span class="c"># Choose largest wavelength bin size of old spectra.</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="k">print</span> <span class="s">&#39;finding new bin size&#39;</span>
        <span class="n">maxwidth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">sp</span><span class="o">.</span><span class="n">wa</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">wa</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spectra</span><span class="p">)</span>
        <span class="n">npts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">wend</span> <span class="o">-</span> <span class="n">wstart</span><span class="p">)</span> <span class="o">/</span> <span class="n">maxwidth</span><span class="p">))</span>      <span class="c"># round up</span>
        <span class="c"># rebin spectra to combined wavelength scale</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="k">print</span> <span class="s">&#39;Rebinning spectra&#39;</span>
        <span class="n">s_rebinned</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">rebin</span><span class="p">(</span><span class="n">wstart</span><span class="o">=</span><span class="n">wstart</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="n">npts</span><span class="p">,</span> <span class="n">dw</span><span class="o">=</span><span class="n">maxwidth</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spectra</span><span class="p">]</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">wstart</span><span class="o">=</span><span class="n">wstart</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="n">npts</span><span class="p">,</span> <span class="n">dw</span><span class="o">=</span><span class="n">maxwidth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="p">(</span><span class="s">&#39;New wavelength scale wstart=</span><span class="si">%s</span><span class="s">, wend=</span><span class="si">%s</span><span class="s">, npts=</span><span class="si">%s</span><span class="s">, dw=</span><span class="si">%s</span><span class="s">&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">wstart</span><span class="p">,</span> <span class="n">combined</span><span class="o">.</span><span class="n">wa</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">npts</span><span class="p">,</span> <span class="n">maxwidth</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">wa</span><span class="o">=</span><span class="n">spec0</span><span class="o">.</span><span class="n">wa</span><span class="p">)</span>
        <span class="n">s_rebinned</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">spectra</span><span class="p">)</span>

    <span class="c"># sigma clipping, if requested</span>
    <span class="k">if</span> <span class="n">cliphi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cliplo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">clip</span><span class="p">(</span><span class="n">cliphi</span><span class="p">,</span> <span class="n">cliplo</span><span class="p">,</span> <span class="n">s_rebinned</span><span class="p">)</span>
        <span class="c"># repeat, clipping to 4 sigma this time</span>
        <span class="c">#npixclipped = clip(4.,4.,s_rebinned)</span>

    <span class="c"># Now add the spectra</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combined</span><span class="o">.</span><span class="n">wa</span><span class="p">)):</span>
        <span class="n">wtot</span> <span class="o">=</span> <span class="n">fltot</span> <span class="o">=</span> <span class="n">ertot</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c"># num of old spectrum pixels contributing to new</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s_rebinned</span><span class="p">:</span>
            <span class="c"># if not a sensible flux value, skip to the next pixel</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">npix</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c"># Weighted mean (weight by inverse variance)</span>
                <span class="n">variance</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="n">w</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">variance</span>
                <span class="n">fltot</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span>
                <span class="n">ertot</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">wtot</span> <span class="o">+=</span> <span class="n">w</span>
        <span class="k">if</span> <span class="n">npix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">combined</span><span class="o">.</span><span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fltot</span> <span class="o">/</span> <span class="n">wtot</span>
            <span class="n">combined</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ertot</span><span class="p">)</span> <span class="o">/</span> <span class="n">wtot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined</span><span class="o">.</span><span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">combined</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c">#contributing.fl[i] = npix_contrib</span>
    <span class="k">return</span> <span class="n">combined</span>
</div>
<div class="viewcode-block" id="cr_reject"><a class="viewcode-back" href="../../generated/barak.spec.cr_reject.html#barak.spec.cr_reject">[docs]</a><span class="k">def</span> <span class="nf">cr_reject</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Given flux and errors, rejects cosmic-ray type or dead</span>
<span class="sd">    pixels. These are defined as pixels that are more than</span>
<span class="sd">    nsigma*sigma above or below the median of the npixEL pixels on</span>
<span class="sd">    either side.</span>

<span class="sd">    Returns newflux,newerror where the rejected pixels have been</span>
<span class="sd">    replaced by the median value of npix to either side, and the</span>
<span class="sd">    error has been set to NaN.</span>

<span class="sd">    The default values work ok for S/N~20, Resolution=500 spectra.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="k">print</span> <span class="n">nsigma</span><span class="p">,</span><span class="n">npix</span>
    <span class="n">flux</span><span class="p">,</span><span class="n">error</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flux</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>  <span class="c"># make copies</span>
    <span class="n">i1</span> <span class="o">=</span> <span class="n">npix</span>
    <span class="n">i2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span> <span class="o">-</span> <span class="n">npix</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">):</span>
        <span class="c"># make a list of flux values used to find the median</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">npix</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">npix</span><span class="p">]</span>
        <span class="n">er</span> <span class="o">=</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">npix</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">npix</span><span class="p">]</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span><span class="n">er</span><span class="p">)</span> <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">er</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">er</span> <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">medfl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
        <span class="n">meder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">er</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">medfl</span><span class="p">)</span> <span class="o">/</span> <span class="n">meder</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nsigma</span><span class="p">:</span>
            <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">medfl</span>
            <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">fl</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">er</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flux</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="cr_reject2"><a class="viewcode-back" href="../../generated/barak.spec.cr_reject2.html#barak.spec.cr_reject2">[docs]</a><span class="k">def</span> <span class="nf">cr_reject2</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="p">,</span> <span class="n">nsig</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">grow</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; interpolate across features that have widths smaller than the</span>
<span class="sd">    expected fwhm resolution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fwhm: int</span>
<span class="sd">      Resolution fwhm in pixels</span>
<span class="sd">    fl : array of floats, shape (N,)</span>
<span class="sd">      Flux</span>
<span class="sd">    er : array of floats, shape (N,)</span>
<span class="sd">      Error</span>

<span class="sd">    Returns the interpolated flux and error arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fl</span><span class="p">,</span> <span class="n">er</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="p">))</span>
    <span class="c"># interpolate over bad pixels </span>
    <span class="n">fl1</span> <span class="o">=</span> <span class="n">convolve_psf</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">)</span>
    <span class="n">ibad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fl1</span> <span class="o">-</span> <span class="n">fl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nsig</span><span class="o">*</span><span class="n">er</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibad</span><span class="p">)</span>
    <span class="n">extras1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ibad</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grow</span><span class="p">)])</span> 
    <span class="n">extras2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ibad</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grow</span><span class="p">)])</span> 
    <span class="n">ibad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">ibad</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">extras1</span><span class="p">,</span> <span class="n">extras2</span><span class="p">))</span>
    <span class="n">ibad</span> <span class="o">=</span> <span class="n">ibad</span><span class="p">[(</span><span class="n">ibad</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ibad</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">fl</span><span class="p">))]</span>
    <span class="n">igood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fl1</span><span class="p">)),</span> <span class="n">ibad</span><span class="p">)</span>
    <span class="n">fl</span><span class="p">[</span><span class="n">ibad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">ibad</span><span class="p">,</span> <span class="n">igood</span><span class="p">,</span> <span class="n">fl</span><span class="p">[</span><span class="n">igood</span><span class="p">])</span>
    <span class="n">er</span><span class="p">[</span><span class="n">ibad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">fl</span><span class="p">,</span><span class="n">er</span>
</div>
<div class="viewcode-block" id="scalemult"><a class="viewcode-back" href="../../generated/barak.spec.scalemult.html#barak.spec.scalemult">[docs]</a><span class="k">def</span> <span class="nf">scalemult</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; find the constant to multipy f1 by so its median will match</span>
<span class="sd">    f0 where they overlap in wavelength.</span>
<span class="sd">    </span>
<span class="sd">    Errors are just used to identify bad pixels, if they are all &gt; 0</span>
<span class="sd">    they are ignored.</span>

<span class="sd">    `mask` is optional, and of the form `[(3500,4500), (4650,4680)]`</span>
<span class="sd">    to mask wavelengths from 3500 to 4500 Ang, and 4650 to 4680 Ang</span>
<span class="sd">    for example.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w0</span><span class="p">,</span><span class="n">f0</span><span class="p">,</span><span class="n">e0</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">f1</span><span class="p">,</span><span class="n">e1</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">,</span> <span class="p">[</span><span class="n">w0</span><span class="p">,</span><span class="n">f0</span><span class="p">,</span><span class="n">e0</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">f1</span><span class="p">,</span><span class="n">e1</span><span class="p">])</span>
    <span class="n">masked0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w0</span><span class="p">),</span> <span class="nb">bool</span><span class="p">)</span>
    <span class="n">masked1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w0</span><span class="p">),</span> <span class="nb">bool</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">wmin</span><span class="p">,</span><span class="n">wmax</span> <span class="ow">in</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">masked0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">wmin</span> <span class="o">&lt;</span> <span class="n">w0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">w0</span> <span class="o">&lt;</span> <span class="n">wmax</span><span class="p">)</span>  
            <span class="n">masked1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">wmin</span> <span class="o">&lt;</span> <span class="n">w1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">w1</span> <span class="o">&lt;</span> <span class="n">wmax</span><span class="p">)</span>  

    <span class="n">wmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">w0</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">w1</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">wmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w0</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">w1</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    
    <span class="n">good0</span> <span class="o">=</span> <span class="p">(</span><span class="n">e0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">f0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">masked0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wmin</span> <span class="o">&lt;</span> <span class="n">w0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">w0</span> <span class="o">&lt;</span> <span class="n">wmax</span><span class="p">)</span>
    <span class="n">good1</span> <span class="o">=</span> <span class="p">(</span><span class="n">e1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">masked1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wmin</span> <span class="o">&lt;</span> <span class="n">w1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">w1</span> <span class="o">&lt;</span> <span class="n">wmax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">good0</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">good1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Too few good pixels to use for scaling&#39;</span><span class="p">)</span>

    <span class="n">med0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">f0</span><span class="p">[</span><span class="n">good0</span><span class="p">])</span>
    <span class="n">med1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">f1</span><span class="p">[</span><span class="n">good1</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">med0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">med1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;bad medians:&#39;</span><span class="p">,</span> <span class="n">med0</span><span class="p">,</span> <span class="n">med1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">med0</span> <span class="o">/</span> <span class="n">med1</span>
</div>
<div class="viewcode-block" id="scale_overlap"><a class="viewcode-back" href="../../generated/barak.spec.scale_overlap.html#barak.spec.scale_overlap">[docs]</a><span class="k">def</span> <span class="nf">scale_overlap</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">e1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Scale two spectra to match where they overlap. Assumes</span>
<span class="sd">    spectrum 0 covers a lower wavelength range than spectrum 1. If no</span>
<span class="sd">    good regions overlap, regions close to the overlap are searched</span>
<span class="sd">    for.</span>

<span class="sd">    Returns::</span>

<span class="sd">     scale_factor : float</span>
<span class="sd">         Multiply spectrum 1 by scale_factor to match spectrum 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

   <span class="c"># find overlapping regions</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;wa&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">),(</span><span class="s">&#39;fl&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">),(</span><span class="s">&#39;er&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">)]</span>
    <span class="n">sp0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">([</span><span class="n">w0</span><span class="p">,</span><span class="n">f0</span><span class="p">,</span><span class="n">e0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">sp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">([</span><span class="n">w1</span><span class="p">,</span><span class="n">f1</span><span class="p">,</span><span class="n">e1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sp0</span><span class="o">.</span><span class="n">wa</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">sp1</span><span class="o">.</span><span class="n">wa</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No overlap!&#39;</span><span class="p">)</span>
    <span class="c"># find first overlapping good pixel</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sp1</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>  <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">i0min</span> <span class="o">=</span> <span class="n">sp0</span><span class="o">.</span><span class="n">wa</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">sp1</span><span class="o">.</span><span class="n">wa</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sp0</span><span class="o">.</span><span class="n">er</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>  <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">i1max</span> <span class="o">=</span> <span class="n">sp1</span><span class="o">.</span><span class="n">wa</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">sp0</span><span class="o">.</span><span class="n">wa</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="n">sp0</span><span class="p">[</span><span class="n">i0min</span><span class="p">:]</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">sp1</span><span class="p">[:</span><span class="n">i1max</span><span class="p">]</span>
        <span class="n">good0</span> <span class="o">=</span> <span class="p">(</span><span class="n">s0</span><span class="o">.</span><span class="n">er</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s0</span><span class="o">.</span><span class="n">fl</span><span class="p">)</span>
        <span class="n">good1</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">er</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">fl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">good0</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">good1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i0min</span> <span class="o">=</span> <span class="n">i0min</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sp0</span><span class="p">)</span> <span class="o">-</span> <span class="n">i0min</span><span class="p">)</span>
            <span class="n">i1max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i1max</span>
            <span class="k">if</span> <span class="n">i0min</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i1max</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No good pixels to use for scaling&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">m0</span><span class="p">,</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">s0</span><span class="o">.</span><span class="n">fl</span><span class="p">[</span><span class="n">good0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">fl</span><span class="p">[</span><span class="n">good1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">m0</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;looping&#39;</span>
            <span class="n">i0min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i0min</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sp0</span><span class="p">)</span> <span class="o">-</span> <span class="n">i0min</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">m1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;looping&#39;</span>
            <span class="n">i1max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sp1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i1max</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
        
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>  <span class="k">print</span> <span class="n">m0</span><span class="p">,</span><span class="n">m1</span>
    <span class="k">return</span> <span class="n">m0</span> <span class="o">/</span> <span class="n">m1</span>

</div>
<div class="viewcode-block" id="plotlines"><a class="viewcode-back" href="../../generated/barak.spec.plotlines.html#barak.spec.plotlines">[docs]</a><span class="k">def</span> <span class="nf">plotlines</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">atmos</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;dotted&#39;</span><span class="p">,</span>
              <span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">trim</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Draw vertical dotted lines showing expected positions of</span>
<span class="sd">    absorption and emission lines, given a redshift.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atmos : list of float pairs, or True (None)</span>
<span class="sd">      Regions of atmospheric absorption to plot. If True, it uses an</span>
<span class="sd">      internal list of regions.</span>
<span class="sd">    lines : stuctured array, optional</span>
<span class="sd">      If given, it must be a record array with fields &#39;name&#39; and &#39;wa&#39;.</span>

<span class="sd">    Returns the mpl artists representing the lines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lines</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">readtxt</span><span class="p">(</span><span class="n">DATAPATH</span> <span class="o">+</span> <span class="s">&#39;linelists/galaxy_lines&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s">&#39;wa,name,select&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromrecords</span><span class="p">([(</span><span class="n">l</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="s">&#39;wa&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">],</span>
                                   <span class="n">names</span><span class="o">=</span><span class="s">&#39;name,wa&#39;</span><span class="p">)</span>
    <span class="n">autoscale</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_autoscale_on</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">autoscale</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_autoscale_on</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">artists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">w0</span><span class="p">,</span><span class="n">w1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="n">wa</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">wa</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">trim</span><span class="p">:</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">between</span><span class="p">(</span><span class="n">wa</span><span class="p">,</span><span class="n">w0</span><span class="p">,</span><span class="n">w1</span><span class="p">)</span>
        <span class="n">wa</span> <span class="o">=</span> <span class="n">wa</span><span class="p">[</span><span class="n">c0</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">c0</span><span class="p">]</span>
    <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axvlines</span><span class="p">(</span><span class="n">wa</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">w</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wa</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="mi">3</span><span class="p">],</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="mi">3</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">w0</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">w1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">trim</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c">#name = l.name + &#39;%.2f&#39; % l.wa</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">puttext</span><span class="p">(</span>
                    <span class="n">w</span><span class="p">,</span> <span class="mf">0.7</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span>
                    <span class="n">xcoord</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                    <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">&#39;right&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">atmos</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atmos</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">atmos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plotatmos</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">atmos</span><span class="o">=</span><span class="n">atmos</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">autoscale</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_autoscale_on</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">artists</span>

</div>
<div class="viewcode-block" id="plotatmos"><a class="viewcode-back" href="../../generated/barak.spec.plotatmos.html#barak.spec.plotatmos">[docs]</a><span class="k">def</span> <span class="nf">plotatmos</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">atmos</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot rough areas where atmospheric absorption is expected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">autoscale</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_autoscale_on</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">autoscale</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_autoscale_on</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">artists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">atmos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">atmos</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">5570</span><span class="p">,</span> <span class="mi">5590</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">5885</span><span class="p">,</span> <span class="mi">5900</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">6275</span><span class="p">,</span> <span class="mi">6325</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">6870</span><span class="p">,</span> <span class="mi">6950</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">7170</span><span class="p">,</span> <span class="mi">7350</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">7580</span><span class="p">,</span> <span class="mi">7690</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">8130</span><span class="p">,</span> <span class="mi">8350</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">8900</span><span class="p">,</span> <span class="mi">9200</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">9300</span><span class="p">,</span> <span class="mi">9850</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">11100</span><span class="p">,</span> <span class="mi">11620</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">12590</span><span class="p">,</span> <span class="mi">12790</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">13035</span><span class="p">,</span> <span class="mi">15110</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">17435</span><span class="p">,</span> <span class="mi">20850</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">24150</span><span class="p">,</span> <span class="mi">24800</span><span class="p">)]</span>

    <span class="n">artists</span> <span class="o">=</span> <span class="n">axvfill</span><span class="p">(</span><span class="n">atmos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">autoscale</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_autoscale_on</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">artists</span>
</div>
<div class="viewcode-block" id="plot"><a class="viewcode-back" href="../../generated/barak.spec.plot.html#barak.spec.plot">[docs]</a><span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">yperc</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
         <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;steps-mid&#39;</span><span class="p">,</span> <span class="n">flcolor</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">cocolor</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plots spectrum.</span>

<span class="sd">    Returns the matplotlib artists that represent the flux, error</span>
<span class="sd">    and continuum curves.</span>

<span class="sd">    Can also give a single argument that is a record array with fields</span>
<span class="sd">    wa, fl and optionally er, co.</span>

<span class="sd">    &gt;&gt;&gt; from utilities import get_data_path</span>
<span class="sd">    &gt;&gt;&gt; sp = read(get_data_path() + &#39;tests/spSpec-52017-0516-139.fit.gz&#39;)</span>
<span class="sd">    &gt;&gt;&gt; lines = plot(sp.wa, sp.fl, sp.er, sp.co, show=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">witherr</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">e</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">wa</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fl</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">er</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">witherr</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">co</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">elif</span> <span class="n">e</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">witherr</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">elif</span> <span class="n">c</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.94</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">artists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c"># check we have something to plot...</span>
    
    <span class="n">good</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">witherr</span><span class="p">:</span>
        <span class="n">good</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">good</span><span class="p">):</span>
        <span class="n">artists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">flcolor</span><span class="p">,</span>
                               <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">linestyle</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">witherr</span><span class="p">:</span>
            <span class="n">artists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">flcolor</span><span class="p">,</span>
                                   <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;dashed&#39;</span><span class="p">))</span>
        <span class="n">artists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cocolor</span><span class="p">,</span>
                               <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">))</span>
        <span class="c"># plotting limits</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">good</span><span class="p">]</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="n">yperc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">witherr</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">good</span><span class="p">]</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">ymax</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ymax</span> <span class="o">&lt;</span> <span class="n">ymin</span><span class="p">:</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">((</span><span class="n">w</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">w</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">artists</span>

</div>
<div class="viewcode-block" id="writesp"><a class="viewcode-back" href="../../generated/barak.spec.writesp.html#barak.spec.writesp">[docs]</a><span class="k">def</span> <span class="nf">writesp</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">resvel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Writes out a spectrum, as ascii for now - wavelength, flux,</span>
<span class="sd">    error, continuum.</span>

<span class="sd">    sp must have attributes wa, fl, er and optionally co.</span>

<span class="sd">    Keyword overwrite can be True or False.</span>

<span class="sd">    resvel means the instrumental fwhm in km/s will be written on the</span>
<span class="sd">    first line (VPFIT style).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lexists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;File </span><span class="si">%s</span><span class="s"> exists - overwrite? (y) or n: &#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;n&#39;</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;returning without writing anything...&#39;</span>
                <span class="k">return</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resvel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;RESVEL </span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">resvel</span><span class="p">)</span>

    <span class="n">fl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">fl</span><span class="p">)</span>
    <span class="n">er</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">er</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="s">&#39;co&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">co</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">w</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">wa</span><span class="p">,</span> <span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="p">):</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">% .12g</span><span class="s"> </span><span class="si">% #12.8g</span><span class="s"> </span><span class="si">% #12.8g</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">co</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">w</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">wa</span><span class="p">,</span> <span class="n">fl</span><span class="p">,</span> <span class="n">er</span><span class="p">,</span> <span class="n">co</span><span class="p">):</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">% .12g</span><span class="s"> </span><span class="si">% #12.8g</span><span class="s"> </span><span class="si">% #12.8g</span><span class="s"> </span><span class="si">% #12.8g</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


    </div>
<div class="viewcode-block" id="find_cont"><a class="viewcode-back" href="../../generated/barak.spec.find_cont.html#barak.spec.find_cont">[docs]</a><span class="k">def</span> <span class="nf">find_cont</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">fwhm1</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">fwhm2</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">nchunks</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Given the flux, estimate the continuum. fwhm values are</span>
<span class="sd">    smoothing lengths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># smooth flux, with smoothing length much longer than expected</span>
    <span class="c"># emission line widths.</span>
    <span class="n">fl</span> <span class="o">=</span> <span class="n">nan2num</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="s">&#39;mean&#39;</span><span class="p">)</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">convolve_psf</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">fwhm1</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    
    <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
    
    <span class="c"># throw away top and bottom 2% of data that deviates from</span>
    <span class="c"># continuum and re-fit new continuum. Go chunk by chunk so that</span>
    <span class="c"># points are thrown away evenly across the spectrum.</span>
    <span class="n">nfl</span> <span class="o">=</span> <span class="n">fl</span> <span class="o">/</span> <span class="n">co</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">npts</span> <span class="o">//</span> <span class="n">nchunks</span>  <span class="o">+</span> <span class="mi">1</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">npts</span><span class="p">]</span>
    <span class="n">igood</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i0</span><span class="p">,</span><span class="n">i1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ind</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">isort</span> <span class="o">=</span> <span class="n">nfl</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">len_isort</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">isort</span><span class="p">)</span>
        <span class="n">j0</span><span class="p">,</span><span class="n">j1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">len_isort</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.95</span> <span class="o">*</span> <span class="n">len_isort</span><span class="p">)</span>
        <span class="n">igood</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">isort</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">]</span><span class="o">+</span><span class="n">i0</span><span class="p">)</span>

    <span class="n">good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">igood</span><span class="p">)</span>
    <span class="n">sfl</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">sfl</span><span class="p">[</span><span class="o">~</span><span class="n">good</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="o">~</span><span class="n">good</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">sfl</span><span class="p">[</span><span class="n">good</span><span class="p">])</span>

    <span class="n">co</span> <span class="o">=</span> <span class="n">convolve_psf</span><span class="p">(</span><span class="n">sfl</span><span class="p">,</span> <span class="n">fwhm2</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">co</span>
    </div>
<div class="viewcode-block" id="find_err"><a class="viewcode-back" href="../../generated/barak.spec.find_err.html#barak.spec.find_err">[docs]</a><span class="k">def</span> <span class="nf">find_err</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">nchunks</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Given a continuum and flux array, return a very rough estimate</span>
<span class="sd">    of the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">midpoints</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">npts</span> <span class="o">//</span> <span class="n">nchunks</span>  <span class="o">+</span> <span class="mi">1</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">npts</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="c">#print i,j</span>
        <span class="n">imid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">))</span>
        <span class="n">midpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imid</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">co</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="c"># throw away top and bottom 5% of these</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">df</span><span class="p">)[</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.05</span><span class="o">*</span><span class="n">n</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.95</span><span class="o">*</span><span class="n">n</span><span class="p">)]</span>
        <span class="n">rms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
    <span class="n">er</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fl</span><span class="p">)),</span> <span class="n">midpoints</span><span class="p">,</span> <span class="n">rms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">er</span>
</div>
<div class="viewcode-block" id="pca_qso_cont"><a class="viewcode-back" href="../../generated/barak.spec.pca_qso_cont.html#barak.spec.pca_qso_cont">[docs]</a><span class="k">def</span> <span class="nf">pca_qso_cont</span><span class="p">(</span><span class="n">nspec</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">return_weights</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Make qso continua using the PCA and weights from N. Suzuki et</span>
<span class="sd">    al. 2005 and N. Suzuki 2006.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nspec : int</span>
<span class="sd">      Number of spectra to create</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wavelength (shape N), array of spectra [shape (nspec, N)]</span>

<span class="sd">    Memory use might be prohibitive for nspec &gt; ~1e4.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># read the principle components</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">DATAPATH</span> <span class="o">+</span> <span class="s">&#39;/PCAcont/Suzuki05/tab3.txt&#39;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="s">&#39;wa,mu,musig,e1,e2,e3,e4,e5,e6,e7,e8,e9,e10&#39;</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">readtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
    <span class="c"># use only the first 7 eigenvetors</span>
    <span class="n">eig</span> <span class="o">=</span> <span class="p">[</span><span class="n">co</span><span class="p">[</span><span class="s">&#39;e</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)]</span>
    <span class="c"># from Suzuki et al 2006.</span>
    <span class="n">csig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">7.563</span><span class="p">,</span> <span class="mf">3.604</span><span class="p">,</span> <span class="mf">2.351</span><span class="p">,</span> <span class="mf">2.148</span><span class="p">,</span> <span class="mf">1.586</span><span class="p">,</span>
                     <span class="mf">1.479</span><span class="p">,</span> <span class="mf">1.137</span><span class="p">])</span> <span class="c">#, 0.778, 0.735, 0.673])</span>

    <span class="c"># generate weights for each eigenvector</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">csig</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nspec</span><span class="p">)</span>
        <span class="c"># make sure we don&#39;t have any very large deviations from the mean</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">][:</span><span class="n">nspec</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">==</span> <span class="n">nspec</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span> <span class="o">*</span> <span class="n">sig</span><span class="p">)</span>

    <span class="c"># generate nspec continua. loop over pixels</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">wa</span><span class="p">)):</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">eig</span><span class="p">)))</span>

    <span class="n">sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_weights</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">co</span><span class="o">.</span><span class="n">wa</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">weights</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">co</span><span class="o">.</span><span class="n">wa</span><span class="p">,</span> <span class="n">sp</span>
</div>
<div class="viewcode-block" id="vac2air_Ciddor"><a class="viewcode-back" href="../../generated/barak.spec.vac2air_Ciddor.html#barak.spec.vac2air_Ciddor">[docs]</a><span class="k">def</span> <span class="nf">vac2air_Ciddor</span><span class="p">(</span><span class="n">vacw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert vacuum wavelengths in Angstroms to air wavelengths.</span>

<span class="sd">    This uses the relation from Ciddor 1996, Applied Optics LP,</span>
<span class="sd">    vol. 35, Issue 9, p.1566. Only valid for wavelengths &gt; 2000 Ang.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vacw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">vacw</span><span class="p">)</span>
    <span class="n">k0</span> <span class="o">=</span> <span class="mf">238.0185</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="mf">1e-8</span> <span class="o">*</span> <span class="mf">5792105.</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="mf">57.362</span>
    <span class="n">k3</span> <span class="o">=</span> <span class="mf">1e-8</span> <span class="o">*</span> <span class="mf">167917.</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e4</span> <span class="o">/</span> <span class="n">vacw</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">k1</span><span class="o">/</span><span class="p">(</span><span class="n">k0</span> <span class="o">-</span> <span class="n">s2</span><span class="p">)</span> <span class="o">+</span> <span class="n">k3</span><span class="o">/</span><span class="p">(</span><span class="n">k2</span> <span class="o">-</span> <span class="n">s2</span><span class="p">)</span>
    <span class="n">airw</span> <span class="o">=</span> <span class="n">vacw</span> <span class="o">/</span> <span class="n">n</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">airw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">airw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">airw</span>
</div>
<div class="viewcode-block" id="vac2air_Morton"><a class="viewcode-back" href="../../generated/barak.spec.vac2air_Morton.html#barak.spec.vac2air_Morton">[docs]</a><span class="k">def</span> <span class="nf">vac2air_Morton</span><span class="p">(</span><span class="n">vacw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert vacuum wavelengths in Angstroms to air wavelengths.</span>
<span class="sd">    </span>
<span class="sd">    This uses the relation from Morton 1991, ApJS, 77, 119. Only valid</span>
<span class="sd">    for wavelengths &gt; 2000 Ang.  Use this for compatibility with older</span>
<span class="sd">    spectra that may have been corrected using the (older) Morton</span>
<span class="sd">    relation.  The Ciddor relation used in vac2air_Ciddor() is claimed</span>
<span class="sd">    to be more accurate at IR wavelengths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vacw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">vacw</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e4</span> <span class="o">/</span> <span class="n">vacw</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">airw</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">6.4328e-5</span> <span class="o">+</span> <span class="mf">2.94981e-2</span><span class="o">/</span><span class="p">(</span><span class="mi">146</span> <span class="o">-</span> <span class="n">temp</span><span class="p">)</span> <span class="o">+</span>
                 <span class="mf">2.5540e-4</span><span class="o">/</span><span class="p">(</span><span class="mi">41</span> <span class="o">-</span> <span class="n">temp</span><span class="p">))</span> <span class="o">*</span> <span class="n">vacw</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">airw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">airw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">airw</span>
</div>
<div class="viewcode-block" id="air2vac_Morton"><a class="viewcode-back" href="../../generated/barak.spec.air2vac_Morton.html#barak.spec.air2vac_Morton">[docs]</a><span class="k">def</span> <span class="nf">air2vac_Morton</span><span class="p">(</span><span class="n">airw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert air wavelengths in Angstroms to vacuum wavelengths.</span>
<span class="sd">    </span>
<span class="sd">    Uses linear interpolation of the inverse transformation for</span>
<span class="sd">    vac2air_Morton. The fractional error (wa - watrue) / watrue</span>
<span class="sd">    introduced by interpolation is &lt; 1e-9.</span>

<span class="sd">    Only valid for wa &gt; 2000 Angstroms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">airw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">airw</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">airw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Wavelengths must be sorted lowest to highest&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">airw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Only valid for wavelengths &gt; 2000 Angstroms&#39;</span><span class="p">)</span>
    <span class="n">dwmax</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vac2air_Morton</span><span class="p">(</span><span class="n">airw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">airw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10</span>
    <span class="n">dwmin</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vac2air_Morton</span><span class="p">(</span><span class="n">airw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">airw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10</span>
    <span class="n">testvac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">airw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dwmin</span><span class="p">,</span> <span class="n">airw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dwmax</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">testair</span> <span class="o">=</span> <span class="n">vac2air_Morton</span><span class="p">(</span><span class="n">testvac</span><span class="p">)</span>
    <span class="n">vacw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">airw</span><span class="p">,</span> <span class="n">testair</span><span class="p">,</span> <span class="n">testvac</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vacw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vacw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">vacw</span>
</div>
<div class="viewcode-block" id="air2vac_Ciddor"><a class="viewcode-back" href="../../generated/barak.spec.air2vac_Ciddor.html#barak.spec.air2vac_Ciddor">[docs]</a><span class="k">def</span> <span class="nf">air2vac_Ciddor</span><span class="p">(</span><span class="n">airw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert air wavelengths in Angstroms to vacuum wavelengths.</span>
<span class="sd">    </span>
<span class="sd">    Uses linear interpolation of the inverse transformation for</span>
<span class="sd">    vac2air_Ciddor. The fractional error (wa - watrue) / watrue</span>
<span class="sd">    introduced by interpolation is &lt; 1e-9.</span>

<span class="sd">    Only valid for wa &gt; 2000 Angstroms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">airw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">airw</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">airw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Wavelengths must be sorted lowest to highest&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">airw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Only valid for wavelengths &gt; 2000 Angstroms&#39;</span><span class="p">)</span>

    <span class="n">dwmax</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vac2air_Ciddor</span><span class="p">(</span><span class="n">airw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">airw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10</span>
    <span class="n">dwmin</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vac2air_Ciddor</span><span class="p">(</span><span class="n">airw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">airw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10</span>
    <span class="n">testvac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">airw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dwmin</span><span class="p">,</span> <span class="n">airw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dwmax</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">testair</span> <span class="o">=</span> <span class="n">vac2air_Ciddor</span><span class="p">(</span><span class="n">testvac</span><span class="p">)</span>
    <span class="n">vacw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">airw</span><span class="p">,</span> <span class="n">testair</span><span class="p">,</span> <span class="n">testvac</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vacw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vacw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">vacw</span>
</div>
<div class="viewcode-block" id="qso_template"><a class="viewcode-back" href="../../generated/barak.spec.qso_template.html#barak.spec.qso_template">[docs]</a><span class="k">def</span> <span class="nf">qso_template</span><span class="p">(</span><span class="n">wa</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a composite visible QSO spectrum at redshift z.</span>

<span class="sd">    The SDSS composite spectrum as a function of F_lambda is returned</span>
<span class="sd">    at each wavelength of wa. wa must be in angstroms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">readtabfits</span><span class="p">(</span><span class="n">DATAPATH</span> <span class="o">+</span> <span class="s">&#39;/templates/qso/dr1QSOspec.fits&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wa</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">wa</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">fl</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="qso_template_uv"><a class="viewcode-back" href="../../generated/barak.spec.qso_template_uv.html#barak.spec.qso_template_uv">[docs]</a><span class="k">def</span> <span class="nf">qso_template_uv</span><span class="p">(</span><span class="n">wa</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">smooth_fwhmpix</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a composite UV QSO spectrum at redshift z.</span>

<span class="sd">    Wavelengths must be in Angstroms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">DATAPATH</span> <span class="o">+</span> <span class="s">&#39;templates/qso/telfer_composite_qso.txt&#39;</span><span class="p">,</span>
                         <span class="n">unpack</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wa</span><span class="p">,</span> <span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">fl</span> <span class="o">=</span> <span class="n">convolve_psf</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">smooth_fwhmpix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fl</span>
</div>
<div class="viewcode-block" id="make_constant_dv_wa_scale"><a class="viewcode-back" href="../../generated/barak.spec.make_constant_dv_wa_scale.html#barak.spec.make_constant_dv_wa_scale">[docs]</a><span class="k">def</span> <span class="nf">make_constant_dv_wa_scale</span><span class="p">(</span><span class="n">wmin</span><span class="p">,</span> <span class="n">wmax</span><span class="p">,</span> <span class="n">dv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Make a constant velocity width scale given a start and end</span>
<span class="sd">    wavelength, and velocity pixel width.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dlogw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dv</span><span class="o">/</span><span class="n">c_kms</span><span class="p">)</span>
    <span class="c"># find the number of points needed.</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">wmax</span> <span class="o">/</span> <span class="n">wmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">dlogw</span><span class="p">)</span>
    <span class="n">wa</span> <span class="o">=</span> <span class="n">wmin</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span><span class="o">*</span><span class="n">dlogw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wa</span>
</div>
<div class="viewcode-block" id="convolve_constant_dv"><a class="viewcode-back" href="../../generated/barak.spec.convolve_constant_dv.html#barak.spec.convolve_constant_dv">[docs]</a><span class="k">def</span> <span class="nf">convolve_constant_dv</span><span class="p">(</span><span class="n">wa</span><span class="p">,</span> <span class="n">fl</span><span class="p">,</span> <span class="n">wa_dv</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span> <span class="n">vfwhm</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convolve a wavelength array with a gaussian of constant</span>
<span class="sd">    velocity width.</span>

<span class="sd">    If `vfwhm` is specified an intermediate wavelength array with</span>
<span class="sd">    constant velocity pixel width is calculated. Otherwise, both</span>
<span class="sd">    `wa_dv` and `npix` must be given -- this is faster because no</span>
<span class="sd">    intermediate array needs to be calculated.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fl, wa : arrays of floats, length N</span>
<span class="sd">      The array to be convolved and its wavelengths.</span>
<span class="sd">    vfwhm : float, optional</span>
<span class="sd">      Full width at half maximum in velocity space (km/s) of the</span>
<span class="sd">      gaussian kernel with which to convolve `fl`.</span>
<span class="sd">    npix : float, default 4</span>
<span class="sd">      Number of pixels corresponding to `vfwhm` in `wa_dv` if given,</span>
<span class="sd">      otherwise `wa` is interpolated to an array with velocity pixel</span>
<span class="sd">      width = vfwhm / npix.</span>
<span class="sd">    wa_dv : array of floats, default `None`</span>
<span class="sd">      Wavelength array with a constant velocity width (this can be</span>
<span class="sd">      generated with make_constant_dv_wa_scale()).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fl_out : array of length N</span>
<span class="sd">      fl convolved with the gaussian kernel with the specified FWHM.</span>
<span class="sd">     </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># interpolate to the log-linear scale, convolve, then</span>
    <span class="c"># interpolate back again.</span>
    <span class="c"># convolve with the gaussian</span>
    <span class="k">if</span> <span class="n">vfwhm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">wa_dv</span> <span class="o">=</span> <span class="n">make_constant_dv_wa_scale</span><span class="p">(</span><span class="n">wa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wa</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">vfwhm</span><span class="p">)</span><span class="o">/</span><span class="n">npix</span><span class="p">)</span>
    <span class="n">fl_dv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wa_dv</span><span class="p">,</span> <span class="n">wa</span><span class="p">,</span> <span class="n">fl</span><span class="p">)</span>
    <span class="n">fl_dv_smoothed</span> <span class="o">=</span> <span class="n">convolve_psf</span><span class="p">(</span><span class="n">fl_dv</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
    <span class="n">fl_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wa</span><span class="p">,</span> <span class="n">wa_dv</span><span class="p">,</span> <span class="n">fl_dv_smoothed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fl_out</span></div>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, Neil Crighton.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>